{% extends 'layout.html' %}
{% load static %}
{% block bottom_nav %}
{% endblock %}
{% block header %}
<nav class="sticky shadow-sm top-0 flex bg-white px-2 py-2 z-50">
    <a href="/profile" class="flex gap-2 items-center">
        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24">
            <path fill="currentColor" d="m7.825 13l4.9 4.9q.3.3.288.7t-.313.7q-.3.275-.7.288t-.7-.288l-6.6-6.6q-.15-.15-.213-.325T4.425 12q0-.2.063-.375T4.7 11.3l6.6-6.6q.275-.275.688-.275t.712.275q.3.3.3.713t-.3.712L7.825 11H19q.425 0 .713.288T20 12q0 .425-.288.713T19 13H7.825Z" />
        </svg>
        <h2 class="text-xl font-bold">Back</h2>
    </a>
</nav>
{% endblock %}
{% block content %}
<div class="mt-3 mb-4 mx-5 {% if history|length > 3 or history_request|length > 3 %} h-full {% else %} h-screen {% endif %}">
    <div class="flex-col flex gap-6">
        <div>
            <div class="flex gap-2 items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 fill-orange-600" viewBox="0 0 26 26">
                    <g fill-rule="evenodd" clip-rule="evenodd">
                        <path d="M19.015 13.578c-.85-.343-2.092-.578-3.515-.578v-2c1.614 0 3.122.263 4.264.724c.568.23 1.094.528 1.495.91c.402.385.741.922.741 1.588c0 .667-.338 1.203-.741 1.588c-.4.383-.927.681-1.495.91c-1.142.462-2.65.724-4.264.724c-1.614 0-3.122-.262-4.264-.723c-.568-.23-1.094-.528-1.495-.91c-.401-.387-.741-.923-.741-1.59h2l-.001-.015a.477.477 0 0 0 .124.157c.156.15.435.33.863.502c.849.344 2.09.578 3.514.578c1.423 0 2.665-.235 3.515-.578c.427-.172.706-.353.862-.502a.584.584 0 0 0 .117-.142a.586.586 0 0 0-.117-.142c-.156-.149-.435-.33-.862-.502Zm.988.665L20 14.238a.022.022 0 0 1 .002.005ZM20 14.207c0-.004.001-.006.002-.006l-.002.006Zm-9.003-.006v.006v-.006Z" />
                        <path d="M10 13.667a1 1 0 0 1 1 1v3.098c.008.02.035.07.123.155c.156.149.435.33.863.502c.849.343 2.09.578 3.514.578c1.423 0 2.665-.235 3.515-.578c.427-.173.706-.353.862-.502a.5.5 0 0 0 .123-.155v-3.098a1 1 0 0 1 2 0v3.11c0 .667-.338 1.204-.741 1.589c-.4.383-.927.68-1.495.91c-1.142.462-2.65.724-4.264.724c-1.614 0-3.122-.262-4.264-.724c-.568-.23-1.094-.527-1.495-.91C9.34 18.98 9 18.444 9 17.778v-3.111a1 1 0 0 1 1-1Zm10.003 4.09l-.002.005c0-.003.001-.005.002-.005Zm-9.005 0v.005v-.005Z" />
                        <path d="M12.2 19v-2h2v2h-2Zm4.4 0v-2h2v2h-2ZM5.998 8.243v-.005a.016.016 0 0 1 0 .005Zm.008-.02a.582.582 0 0 1 .117-.143c.156-.149.435-.33.863-.502C7.835 7.235 9.076 7 10.5 7c1.423 0 2.665.235 3.514.578c.428.173.707.353.863.502c.073.07.104.117.117.142a.585.585 0 0 1-.117.142c-.156.15-.435.33-.863.502c-.849.344-2.09.578-3.514.578c-1.423 0-2.665-.234-3.514-.578c-.428-.172-.707-.353-.863-.502a.582.582 0 0 1-.117-.142Zm8.996.02v-.005a.021.021 0 0 1 0 .005Zm0-.036V8.2v.006Zm-9.003 0L5.998 8.2v.006Zm.237-2.483C7.378 5.263 8.886 5 10.5 5c1.614 0 3.122.263 4.264.724c.568.23 1.094.528 1.494.91c.404.385.742.922.742 1.588c0 .667-.338 1.203-.742 1.588c-.4.383-.926.681-1.494.91c-1.142.462-2.65.724-4.264.724c-1.614 0-3.122-.262-4.264-.723c-.568-.23-1.094-.528-1.495-.91C4.34 9.424 4 8.888 4 8.221c0-.666.339-1.203.741-1.588c.4-.382.927-.68 1.495-.91Z" />
                        <path d="M5 7.667a1 1 0 0 1 1 1v3.098a.5.5 0 0 0 .123.155c.156.149.435.33.863.502c.849.343 2.09.578 3.514.578c1.423 0 2.665-.235 3.514-.578c.428-.173.707-.353.863-.502a.5.5 0 0 0 .123-.155V8.667a1 1 0 1 1 2 0v3.11c0 .667-.338 1.204-.742 1.589c-.4.383-.926.68-1.494.91c-1.142.462-2.65.724-4.264.724c-1.614 0-3.122-.262-4.264-.724c-.568-.23-1.094-.527-1.495-.91C4.34 12.98 4 12.444 4 11.778V8.667a1 1 0 0 1 1-1Zm10.002 4.09v.005v-.005Zm-9.004 0v.005v-.005Z" />
                        <path d="M7.2 13v-2h2v2h-2Zm4.4 0v-2h2v2h-2Z" />
                        <path d="M13 24c6.075 0 11-4.925 11-11S19.075 2 13 2S2 6.925 2 13s4.925 11 11 11Zm0 2c7.18 0 13-5.82 13-13S20.18 0 13 0S0 5.82 0 13s5.82 13 13 13Z" />
                    </g>
                </svg>
                <p class="font-light text-slate-500 text-sm">Jumlah Saldo Sekarang: <span class="text-lg font-medium text-slate-900">{{ totals }} ùõë</span></p>
            </div>
            <p class="text-sm">{% if profiles %}<strong>Kuota Tersisa : {{ profiles.quota_withdrawl }}</strong>{% endif %}</p>
        </div>
        <div class="flex flex-col gap-2">
            <div class="relative w-full">
                <div class="absolute inset-y-0 left-0 flex items-center pl-3.5 pointer-events-none">
                    <span class="text-slate-500 font-medium">ùõë</span>
                </div>
                <input type="number" id="email-address-icon" class="bg-slate-50 border border-slate-300 text-slate-900 text-sm rounded-lg w-full focus:ring-blue-500 focus:border-blue-500 block pl-10 p-2.5" placeholder="Masukkan Jumlah yang ingin di withdraw" />
            </div>
            <button onclick="my_modal_1.showModal()" class="p-2.5 bg-orange-600 hover:bg-orange-700 rounded-lg flex items-center justify-center gap-2 text-white w-full">
                <span class="flex gap-2" id="wdText">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24">
                        <path fill="currentColor" d="M22 2H2a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h3v9a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-9h3a1 1 0 0 0 1-1V3a1 1 0 0 0-1-1ZM7 20v-2a2 2 0 0 1 2 2Zm10 0h-2a2 2 0 0 1 2-2Zm0-4a4 4 0 0 0-4 4h-2a4 4 0 0 0-4-4V8h10Zm4-6h-2V7a1 1 0 0 0-1-1H6a1 1 0 0 0-1 1v3H3V4h18Zm-9 5a3 3 0 1 0-3-3a3 3 0 0 0 3 3Zm0-4a1 1 0 1 1-1 1a1 1 0 0 1 1-1Z" />
                    </svg>
                    <span>Withdraw</span>
                </span>
                <svg id="spinner" class="hidden" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24">
                    <path fill="currentColor" d="M12,1A11,11,0,1,0,23,12,11,11,0,0,0,12,1Zm0,19a8,8,0,1,1,8-8A8,8,0,0,1,12,20Z" opacity=".25" />
                    <path fill="currentColor" d="M12,4a8,8,0,0,1,7.89,6.7A1.53,1.53,0,0,0,21.38,12h0a1.5,1.5,0,0,0,1.48-1.75,11,11,0,0,0-21.72,0A1.5,1.5,0,0,0,2.62,12h0a1.53,1.53,0,0,0,1.49-1.3A8,8,0,0,1,12,4Z">
                        <animateTransform attributeName="transform" dur="0.75s" repeatCount="indefinite" type="rotate" values="0 12 12;360 12 12" />
                    </path>
                </svg>
            </button>
            <p class="font-thin text-[10px]"><strong class="text-red-600 font-bold">Penting !!!</strong>: Coin akan dikirim ke alamat wallet yang terakhir anda login. Pastikan anda terakhir login di alamat wallet yang anda kehendaki.</p>
        </div>
        <div>
            <h6 class="font-medium text-slate-900 mb-2">Request transaksi</h6>
            <table class="w-full text-sm text-left text-slate-500">
                <thead class="text-xs text-gray-700 uppercase bg-gray-100">
                    <tr>
                        <td class="px-6 py-3 rounded-l-lg">Tanggal</td>
                        <td class="px-6 py-3">Jumlah Pi</td>
                        <td class="px-6 py-3 rounded-r-lg">Status</td>
                    </tr>
                </thead>
                <tbody class="text-xs">
                    {% for h in history_request %}
                    <tr>
                        <td class="px-6 py-4 font-medium text-slate-900 whitespace-nowrap">{{ h.tanggal }}</td>
                        <td class="px-6 py-4">{{ h.jumlah }}ùõë</td>
                        <td>
                            {% if h.status == 1 %}
                            Proses
                            {% elif h.status == 2 %}
                            Selesai
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <div>
            <h6 class="font-medium text-slate-900 mb-2">History transaksi</h6>
            <table class="w-full text-sm text-left text-slate-500">
                <thead class="text-xs text-gray-700 uppercase bg-gray-100">
                    <tr>
                        <td class="px-6 py-3 rounded-l-lg">Tanggal</td>
                        <td class="px-6 py-3 rounded-r-lg">Jumlah Pi</td>
                    </tr>
                </thead>
                <tbody class="text-xs">
                    {% for h in history %}
                    <tr>
                        <td class="px-6 py-4 font-medium text-slate-900 whitespace-nowrap">{{ h.tanggal }}</td>
                        <td class="px-6 py-4">{{ h.jumlah }}ùõë</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
<dialog id="my_modal_1" class="modal modal-bottom">
    <div class="modal-box">
        <div class="text-red-700 text-center" id="pesanerror"></div>
        <h3 class="font-bold text-lg pb-4">Pilih Cara withdrawl</h3>
        <ul class="menu bg-base-200 w-full rounded-box">
            <li><a onclick="wdbuttonrequest(this)">Manual (Request ke admin)</a></li>
            <li class="disabled"><a>Otomatis ( Akan Datang )</a></li>
        </ul>
        <div class="modal-action flex-col gap-2">
            <form method="dialog">
                <button class="btn w-full rounded-full bg-red-600">Tutup</button>
            </form>
        </div>
    </div>
</dialog>
{% endblock %}
{% block script %}
<script>
    const scopes = ['username', 'payments', 'wallet_address'];
    function onIncompletePaymentFound(payment) { /* ... */ };
    async function wdbutton() {
        let text = document.getElementById("wdText");
        let spinner = document.getElementById("spinner");
        text.classList.toggle("hidden");
        spinner.classList.toggle("hidden");
        let value = $('#email-address-icon').val();
        Pi.authenticate(scopes, onIncompletePaymentFound).then(function(auth) {
            console.log(auth);
            let uid = auth.user.uid;
            $.ajax({
                url: "{% url 'widrawl_process' %}",
                data: { jumlah: value ?? 0, user_id: uid },
                success: function(res) {
                    if (res.success) {
                        alert("success");
                        window.location.reload();
                    } else {
                        alert("error server");
                        window.location.reload();
                    }
                }
            });
        }).catch(function(error) {
            alert("ada kesalahan sistem");
            console.error(error);
        });
    }

    async function wdbuttonrequest(ini) {
        $(ini).parent().addClass("disabled");
        $(ini).text("Requesting....");
        let value = $('#email-address-icon').val();
        $.ajax({
            url: "{% url 'widrawl_request_process' %}",
            method: "POST",
            data: { jumlah: value },
            success: function(res) {
                if (!res.success) {
                    $('#pesanerror').text(res.message);
                } else {
                    my_modal_1.close();
                    alert("success request");
                    window.location.reload();
                }
                $(ini).parent().removeClass("disabled");
                $(ini).text("Manual (Request ke admin)");
            },
            error: function() {
                $(ini).parent().removeClass("disabled");
                $(ini).text("Manual (Request ke admin)");
            }
        });
    }
</script>
{% endblock %}
